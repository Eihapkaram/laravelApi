<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Illuminate\Support\Facades\Validator;
use App\Models\Order;
use App\Notifications\CreatOrder;
use App\Notifications\NewOrderNotification;
use App\Notifications\UpdateOrder;
use App\Models\User;
use Illuminate\Support\Facades\Notification;
use Illuminate\Notifications\Notifiable;
use App\Notifications\OrderCreatedBySellerNotification;
use App\Notifications\OrderApprovedNotification;
use App\Notifications\OrderRejectedNotification;
use PhpOffice\PhpSpreadsheet\Spreadsheet;
use PhpOffice\PhpSpreadsheet\Writer\Xlsx;
use PhpOffice\PhpSpreadsheet\IOFactory;

class OrderController extends Controller
{
    // ุฅูุดุงุก ุทูุจ ุฌุฏูุฏ
    public function createOrder(Request $request)
    {
        $user = auth()->user();


        if (!$user) {
            return response()->json(['message' => 'ุบูุฑ ูุตุฑุญ. ุจุฑุฌุงุก ุชุณุฌูู ุงูุฏุฎูู ุฃููุงู.'], 401);
        }

        $validator = Validator::make($request->all(), [
            'city'         => 'required|string|max:100',
            'governorate'  => 'required|string|max:100',
            'street'       => 'required|string|max:255',
            'phone'        => ['required', 'regex:/^(010|011|012|015)[0-9]{8}$/'],
            'store_name'   => 'nullable|string|max:255',
            'status'       => 'nullable|string|in:pending,paid,shipped,completed,cancelled',
            'payment_method' => 'nullable|string|in:cod,credit_card,paypal',
        ]);

        if ($validator->fails()) {
            return response()->json([
                'message' => 'ุฎุทุฃ ูู ุงูุชุญูู ูู ุงูุจูุงูุงุช',
                'errors'  => $validator->errors()
            ], 422);
        }

        $cart = $user->getcart()->with('proCItem.product')->first();

        if (!$cart || $cart->proCItem->isEmpty()) {
            return response()->json(['message' => 'ุงูุณูุฉ ูุงุฑุบุฉ'], 400);
        }

        $total = $cart->proCItem->sum(fn($item) => $item->quantity * $item->product->price);
        
        $order = Order::create([
            'user_id'        => $user->id,
            'total_price'    => $total,
            'status'         => $request->status ?? 'pending',
            'city'           => $request->city,
            'governorate'    => $request->governorate,
            'street'         => $request->street,
            'phone'          => $request->phone,
            'store_name'     => $request->store_name,
            'payment_method' => $request->payment_method,
            
        ]);
        if ($order) {
            // ุฌูุจ ูู ุงููุณุชุฎุฏููู ุงููู ุฑูููู ุฃุฏูู
            $admins = User::where('role', 'admin')->get();

            // ุงุจุนุช ุงูุฅุดุนุงุฑ ูููู
            Notification::send($admins, new CreatOrder($user, $order));
            // ๐ ุฅุฑุณุงู ุฅุดุนุงุฑ ูููุณุชุฎุฏู ููุณู
            $user->notify(new NewOrderNotification($order));
        }

        foreach ($cart->proCItem as $item) {
            $order->orderdetels()->create([
                'product_id' => $item->product_id,
                'quantity'   => $item->quantity,
                'price'      => $item->product->price,
            ]);
        }

        $cart->proCItem()->truncate();

        return response()->json([
            'message' => 'ุชู ุฅูุดุงุก ุงูุทูุจ ุจูุฌุงุญ',
            'order'   => $order->load('orderdetels.product')
        ], 201);
    }



    // โ ุฅูุดุงุก ุทูุจ ุจูุงุณุทุฉ ุจุงุฆุน
    public function createBySeller(Request $request)
    {
        $seller = auth()->user();

        if ($seller->role !== 'seller') {
            return response()->json(['error' => 'ุบูุฑ ูุตุฑุญ ูู ุจุฅูุดุงุก ุทูุจุงุช'], 403);
        }

        $request->validate([
            'user_id' => 'required|exists:users,id',
            'total_price' => 'required|numeric',
            'shipping_address' => 'required|string',
            'city' => 'nullable|string',
            'governorate' => 'nullable|string',
            'street' => 'nullable|string',
            'phone' => 'nullable|string',
            'store_banner' => 'required|image|mimes:jpeg,png,jpg,gif,webp',
        ]);

        $customer = User::find($request->user_id);

        if ($customer->role !== 'customer') {
            return response()->json(['error' => 'ููููู ููุท ุฅูุดุงุก ุทูุจุงุช ูุนููุงุก'], 400);
        }
        // ุฑูุน ุงูุตูุฑุฉ ุงูุฑุฆูุณูุฉ
        $path = null;
        if ($request->hasFile('banner')) {
            $image = $request->file('banner')->getClientOriginalName();
            $path = $request->file('banner')->storeAs('storebanners', $image, 'public');
        }

        $order = Order::create([
            'user_id' => $customer->id,
            'seller_id' => $seller->id,
            'total_price' => $request->total_price,
            'shipping_address' => $request->shipping_address,
            'city' => $request->city,
            'governorate' => $request->governorate,
            'street' => $request->street,
            'phone' => $request->phone,
            'status' => 'pending',
            'approval_status' => 'pending',
            'store_banner' => $path,
        ]);
        $customer->notify(new OrderCreatedBySellerNotification($order, $seller));
        return response()->json([
            'message' => 'ุชู ุฅูุดุงุก ุงูุทูุจ ุจูุฌุงุญ ูู ุงูุชุธุงุฑ ููุงููุฉ ุงูุนููู',
            'order' => $order->load('orderdetels.product','userorder'),
        ], 201);
    }


    // โ ููุงููุฉ ุงูุนููู ุนูู ุงูุทูุจ
    public function approveOrder($id)
    {
        $user = auth()->user();
        $order = Order::findOrFail($id);

        if ($order->user_id !== $user->id) {
            return response()->json(['error' => 'ููุณ ูุฏูู ุตูุงุญูุฉ ููููุงููุฉ ุนูู ูุฐุง ุงูุทูุจ'], 403);
        }

        $order->update([
            'approval_status' => 'approved',
            'approved_at' => now(),
        ]);
        $order->seller->notify(new OrderApprovedNotification($order, $user));
        return response()->json(['message' => 'ุชูุช ุงูููุงููุฉ ุนูู ุงูุทูุจ', 'order' => $order->load('orderdetels.product', 'userorder'),]);
    }
    // โ ุฑูุถ ุงูุทูุจ
    public function rejectOrder($id)
    {
        $user = auth()->user();
        $order = Order::findOrFail($id);

        if ($order->user_id !== $user->id) {
            return response()->json(['error' => 'ููุณ ูุฏูู ุตูุงุญูุฉ ูุฑูุถ ูุฐุง ุงูุทูุจ'], 403);
        }

        $order->update(['approval_status' => 'rejected']);
        $order->seller->notify(new OrderRejectedNotification($order, $user));


        return response()->json(['message' => 'ุชู ุฑูุถ ุงูุทูุจ', 'order' => $order->load('orderdetels.product', 'userorder'),]);
    }

    // ุนุฑุถ  ุนุฏุฏ ุทูุจุงุช ุงููุณุชุฎุฏู ุงูุญุงูู
    public function OrderCount()
    {
        $user = auth()->user();
        $order = $user->getOrder()->count();

        return response()->json([
            'message' => 'ุชู ุฌูุจ  ุนุฏุฏ ุงูุทูุจุงุช ุงูุฎุงุตุฉ ุจู ุจูุฌุงุญ',
            'orderCount'   => $order,
        ], 200);
    }
    // ุนุฑุถ ุทูุจุงุช ุงููุณุชุฎุฏู ุงูุญุงูู
    public function showOrder()
    {
        $user = auth()->user();
        $order = $user->getOrder()->with('orderdetels.product','seller')->get();

        return response()->json([
            'message' => 'ุชู ุฌูุจ ุงูุทูุจุงุช ุงูุฎุงุตุฉ ุจู ุจูุฌุงุญ',
            'order'   => $order,
        ], 200);
    }

    // ุนุฑุถ ุขุฎุฑ ุทูุจ
    public function showlatestOrder()
    {
        $user = auth()->user();
        $orderlatest = $user->getOrder()->with('orderdetels.product','seller')->latest()->first();

        return response()->json([
            'message' => 'ุชู ุฌูุจ ุขุฎุฑ ุทูุจ ุจูุฌุงุญ',
            'orderlatest' => $orderlatest,
        ], 200);
    }

    // ุนุฑุถ ุฌููุน ุงูุทูุจุงุช (ูู admin ููุท)
    public function showAllOrders()
    {
        $user = auth()->user();

        if ($user->role !== 'admin') {
            return response()->json(['message' => 'ุบูุฑ ูุตุฑุญ - ููุท ูููุฏูุฑูู'], 403);
        }

        $orders = Order::with(['orderdetels.product', 'userorder','seller'])->latest()->get();

        return response()->json([
            'message' => 'ุชู ุฌูุจ ุฌููุน ุงูุทูุจุงุช ุจูุฌุงุญ',
            'orders'  => $orders,
        ], 200);
    }

    // ุชุนุฏูู ุญุงูุฉ ุงูุทูุจ (ูุณููุญ ูููุณุชุฎุฏู ุงูุนุงุฏู)
    public function updateOrderStatus(Request $request, $id)
    {
        $user = auth()->user();
        $order = Order::find($id);

        if (!$order) {
            return response()->json(['message' => 'ุงูุทูุจ ุบูุฑ ููุฌูุฏ'], 404);
        }

        // ุงูุณูุงุญ ููุท ูุตุงุญุจ ุงูุทูุจ ุฃู ุงูุฃุฏูู
        if ($order->user_id !== $user->id && $user->role !== 'admin') {
            return response()->json(['message' => 'ุบูุฑ ูุตุฑุญ ูู ุจุชุนุฏูู ูุฐุง ุงูุทูุจ'], 403);
        }

        $validator = Validator::make($request->all(), [
            'status' => 'required|string|in:pending,paid,shipped,completed,cancelled',
        ]);

        if ($validator->fails()) {
            return response()->json([
                'message' => 'ุฎุทุฃ ูู ุงูุชุญูู ูู ุงูุญุงูุฉ ุงูุฌุฏูุฏุฉ',
                'errors'  => $validator->errors(),
            ], 422);
        }

        // ูู ุงููุณุชุฎุฏู ุงูุนุงุฏู ุจูุญุงูู ูุนุฏู
        if ($user->role !== 'admin') {
            // ุงูุญุงูุงุช ุงููุณููุญ ุจูุง ููุท ูููุณุชุฎุฏู
            if (!in_array($request->status, ['pending', 'cancelled'])) {
                return response()->json([
                    'message' => 'ููููู ููุท ุฅูุบุงุก ุงูุทูุจ ุฃู ุฅุฑุฌุงุนู ูุญุงูุฉ ุงูุงูุชุธุงุฑ'
                ], 403);
            }

            // ูุง ูููู ุชุนุฏูู ุญุงูุฉ ุงูุทูุจ ุจุนุฏ ุงูุดุญู ุฃู ุงูุฅููุงู
            if (in_array($order->status, ['shipped', 'completed'])) {
                return response()->json([
                    'message' => 'ูุง ููููู ุชุนุฏูู ุงูุทูุจ ุจุนุฏ ุดุญูู ุฃู ุฅููุงูู'
                ], 403);
            }
        }

        $order->update(['status' => $request->status]);

        return response()->json([
            'message' => 'ุชู ุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจ ุจูุฌุงุญ',
            'order'   => $order,
        ], 200);
        if ($order) {
            // ุฌูุจ ูู ุงููุณุชุฎุฏููู ุงููู ุฑูููู ุฃุฏูู
            $admins = User::where('role', 'admin')->get();

            // ุงุจุนุช ุงูุฅุดุนุงุฑ ูููู
            Notification::send($admins, new UpdateOrder($user));
        }
    }

    // ุญุฐู ุทูุจ (ูููุณุชุฎุฏู ุฃู admin)
    public function deleteOrder($id)
    {
        $user = auth()->user();
        $order = Order::find($id);

        if (!$order) {
            return response()->json(['message' => 'ุงูุทูุจ ุบูุฑ ููุฌูุฏ'], 404);
        }

        if ($order->user_id !== $user->id && $user->role !== 'admin') {
            return response()->json(['message' => 'ุบูุฑ ูุตุฑุญ ูู ุจุญุฐู ูุฐุง ุงูุทูุจ'], 403);
        }

        $order->delete();

        return response()->json(['message' => 'ุชู ุญุฐู ุงูุทูุจ ุจูุฌุงุญ'], 200);
    }

    // ุญุฐู ูู ุงูุทูุจุงุช (ูููุณุชุฎุฏู ุฃู admin)
    public function deleteAllOrder()
    {
        $user = auth()->user();

        if ($user->role === 'admin') {
            Order::truncate();
            return response()->json(['message' => 'ุชู ุญุฐู ุฌููุน ุงูุทูุจุงุช ุจูุงุณุทุฉ ุงููุฏูุฑ'], 200);
        }

        $user->getOrder()->delete();

        return response()->json(['message' => 'ุชู ุญุฐู ุฌููุน ุทูุจุงุชู ุจูุฌุงุญ'], 200);
    }
    // โ ุงุณุชูุฑุงุฏ ุงูุทูุจุงุช ุจุงุณุชุฎุฏุงู PhpSpreadsheet
    public function import(Request $request)
    {
        $request->validate([
            'file' => 'required|mimes:xlsx,xls,csv'
        ]);

        $file = $request->file('file');
        $spreadsheet = IOFactory::load($file->getPathname());
        $sheet = $spreadsheet->getActiveSheet();
        $rows = $sheet->toArray();

        // ุชุฎุทู ุงูุตู ุงูุฃูู (ุงูุนูุงููู)
        foreach (array_slice($rows, 1) as $row) {
            if (!empty($row[1])) { // ุชุฃูุฏ ูู ูุฌูุฏ user_id ูุซูุงู
                Order::updateOrCreate(
                    ['id' => $row[0] ?? null],
                    [
                        'user_id'        => $row[1] ?? null,
                        'seller_id'      => $row[2] ?? null,
                        'total_price'    => $row[3] ?? 0,
                        'status'         => $row[4] ?? 'pending',
                        'city'           => $row[5] ?? null,
                        'governorate'    => $row[6] ?? null,
                        'street'         => $row[7] ?? null,
                        'phone'          => $row[8] ?? null,
                        'payment_method' => $row[9] ?? null,
                        'approval_status'=> $row[10] ?? 'pending',
                    ]
                );
            }
        }

        return response()->json(['message' => 'โ ุชู ุงุณุชูุฑุงุฏ ุงูุทูุจุงุช ุจูุฌุงุญ ุจุงุณุชุฎุฏุงู PhpSpreadsheet']);
    }

    // โ ุชุตุฏูุฑ ุงูุทูุจุงุช ุจุงุณุชุฎุฏุงู PhpSpreadsheet
    public function export()
    {
        $spreadsheet = new Spreadsheet();
        $sheet = $spreadsheet->getActiveSheet();

        // ุฑุคูุณ ุงูุฃุนูุฏุฉ
        $sheet->setCellValue('A1', 'ID');
        $sheet->setCellValue('B1', 'User ID');
        $sheet->setCellValue('C1', 'Seller ID');
        $sheet->setCellValue('D1', 'Total Price');
        $sheet->setCellValue('E1', 'Status');
        $sheet->setCellValue('F1', 'City');
        $sheet->setCellValue('G1', 'Governorate');
        $sheet->setCellValue('H1', 'Street');
        $sheet->setCellValue('I1', 'Phone');
        $sheet->setCellValue('J1', 'Payment Method');
        $sheet->setCellValue('K1', 'Approval Status');

        // ุฌูุจ ุงูุทูุจุงุช
        $orders = Order::with(['userorder', 'seller'])->get();
        $row = 2;

        foreach ($orders as $order) {
            $sheet->setCellValue('A' . $row, $order->id);
            $sheet->setCellValue('B' . $row, $order->user_id);
            $sheet->setCellValue('C' . $row, $order->seller_id);
            $sheet->setCellValue('D' . $row, $order->total_price);
            $sheet->setCellValue('E' . $row, $order->status);
            $sheet->setCellValue('F' . $row, $order->city);
            $sheet->setCellValue('G' . $row, $order->governorate);
            $sheet->setCellValue('H' . $row, $order->street);
            $sheet->setCellValue('I' . $row, $order->phone);
            $sheet->setCellValue('J' . $row, $order->payment_method);
            $sheet->setCellValue('K' . $row, $order->approval_status);
            $row++;
        }

        $writer = new Xlsx($spreadsheet);
        $fileName = 'orders-' . now()->format('Y-m-d_H-i-s') . '.xlsx';
        $filePath = storage_path('app/public/' . $fileName);

        $writer->save($filePath);

        return response()->download($filePath)->deleteFileAfterSend(true);
    }
}
