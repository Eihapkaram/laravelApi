<?php

namespace App\Http\Controllers;

use App\Models\User;
use App\Models\Order;
use App\Models\WithdrawRequest;
use App\Notifications\WithdrawRequestApproved;
use App\Notifications\WithdrawRequestRejected;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Hash;
use App\Notifications\WithdrawRequestSubmitted;
use Illuminate\Support\Facades\Notification;
use App\Notifications\NewWithdrawRequest;
use Illuminate\Support\Str;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;

class SellerCustomerController extends Controller
{
    // ุนุฑุถ ุงูุนููุงุก ุงูุชุงุจุนูู ููุจุงุฆุน
    public function index()
    {
        $seller = Auth::user();
        $customers = $seller->customers; // ุงูุนููุงุก ุงูุชุงุจุนูู ูู
        return response()->json($customers);
    }

    // ูุณุฌู ู ุงููููุน  ุฅุถุงูุฉ ุนููู ููุจุงุฆุน
    // โ ุฅุถุงูุฉ ุนููู ููุจุงุฆุน ุจุงููุงุชู ุฃู ุงูุฅูููู
    public function store(Request $request)
    {
        $request->validate([
            'identifier' => 'required|string', // ูููู ูููู phone ุฃู email
        ]);

        $seller = Auth::user();

        // ุชุฃูุฏ ุฃู ุงููุณุชุฎุฏู ูุนูุงู ุจุงุฆุน
        if ($seller->role !== 'seller') {
            return response()->json(['message' => 'ุบูุฑ ูุตุฑุญ ูู'], 403);
        }

        // ุงูุจุญุซ ุนู ุงูุนููู ุญุณุจ ุงูุฅูููู ุฃู ุฑูู ุงููุงุชู
        $customer = User::where('email', $request->identifier)
            ->orWhere('phone', $request->identifier)
            ->first();

        if (!$customer) {
            return response()->json(['message' => 'ุงูุนููู ุบูุฑ ููุฌูุฏ ูู ุงููุธุงู'], 404);
        }

        // ุฑุจุท ุงูุจุงุฆุน ุจุงูุนููู ุจุฏูู ุชูุฑุงุฑ
        $seller->customers()->syncWithoutDetaching([$customer->id]);

        return response()->json(['message' => 'ุชู ุฅุถุงูุฉ ุงูุนููู ุจูุฌุงุญ']);
    }

    // ุญุฐู ุนููู
    public function destroy($customerId)
    {
        $seller = Auth::user();

        $seller->customers()->detach($customerId);

        return response()->json(['message' => 'ุชู ุญุฐู ุงูุนููู']);
    }
    public function createNewCustomer(Request $request)
    {
        $seller = Auth::user();

        if ($seller->role !== 'seller') {
            return response()->json(['message' => 'ุบูุฑ ูุตุฑุญ ูู'], 403);
        }

        // โ ุงูุชุญูู ูู ุงูุจูุงูุงุช ุงููุทููุจุฉ
        $validated = $request->validate([
            'name' => 'required|string|max:255',
            'phone' => 'required|string|max:20',
            'latitude' => 'required|numeric',
            'longitude' => 'required|numeric',
        ]);

        // ๐ ุงูุจุญุซ ุนู ุงูุนููู ุจุฑูู ุงููุงุชู
        $customer = User::where('phone', $validated['phone'])->first();

        if (!$customer) {
            // โ ุฅูุดุงุก ุนููู ุฌุฏูุฏ
            $customer = User::create([
                'name' => $validated['name'],
                'phone' => $validated['phone'],
                'latitude' => $validated['latitude'],
                'longitude' => $validated['longitude'],
                'role' => 'customer',
                'password' => bcrypt(Str::random(10)), // ูุคูุช
            ]);

            // ุฅูุดุงุก ุชููู ูุชูุนูู ุงูุญุณุงุจ
            $token = Str::random(64);
            DB::table('password_resets')->insert([
                'phone' => $customer->phone,
                'token' => Hash::make($token),
                'created_at' => now(),
            ]);

            $activationLink = url("/reset-password?token={$token}&phone={$customer->phone}");

            // โ ุชูููุฏ ุฑุงุจุท ูุงุชุณุงุจ ูุฅุฑุณุงู ุงูุฑุงุจุท
            $message = "ูุฑุญุจุงู {$customer->name}!\nุชู ุฅูุดุงุก ุญุณุงุจู. ูุชุนููู ูููุฉ ุงููุฑูุฑ ุงุถุบุท ููุง:\n{$activationLink}";
            $phoneForWa = preg_replace('/[^0-9]/', '', $customer->phone);
            $waLink = "https://wa.me/{$phoneForWa}?text=" . urlencode($message);
        }

        // โ ุฑุจุท ุงูุนููู ุจุงูุจุงุฆุน (ุจุฏูู ุชูุฑุงุฑ)
        $seller->customers()->syncWithoutDetaching([$customer->id]);

        return response()->json([
            'message' => $customer->wasRecentlyCreated
                ? 'ุชู ุฅูุดุงุก ุงูุนููู ูุฑุจุทู ุจูุฌุงุญุ ุงุณุชุฎุฏู ุฑุงุจุท ูุงุชุณุงุจ ูุฅุฑุณุงู ุงูุชูุนูู.'
                : 'ุชู ุฑุจุท ุงูุนููู ุงูููุฌูุฏ ูุณุจููุง ุจุงูุจุงุฆุน ุจูุฌุงุญ.',
            'customer' => $customer,
            'waLink' => $waLink ?? null,
        ]);
    }
    public function myCustomers(Request $request)
    {
        $seller = Auth::user();

        if ($seller->role !== 'seller') {
            return response()->json(['message' => 'ุบูุฑ ูุตุฑุญ ูู'], 403);
        }

        $query = $seller->customers()
            ->select('id', 'name', 'phone', 'created_at')
            ->orderBy('created_at', 'desc');

        // ๐ ุงูุจุญุซ ุจุงูุงุณู ุฃู ุฑูู ุงููุงุชู
        if ($search = $request->get('search')) {
            $query->where(function ($q) use ($search) {
                $q->where('name', 'like', "%$search%")
                    ->orWhere('phone', 'like', "%$search%");
            });
        }

        // ๐ ุงูุชุฑููู (10 ุนููุงุก ูู ุงูุตูุญุฉ)
        $customers = $query->paginate(10);

        return response()->json($customers);
    }
    public function show($id)
    {
        $seller = Auth::user();

        // ุชุฃูุฏ ุฃู ุงูุนููู ุชุงุจุน ูุนูุงู ููุจุงุฆุน
        $customer = $seller->customers()->where('users.id', $id)->first();

        if (!$customer) {
            return response()->json(['message' => 'ุงูุนููู ุบูุฑ ููุฌูุฏ ุฃู ุบูุฑ ุชุงุจุน ูู'], 404);
        }

        // ูููู ุชุถูู ูุนูููุงุช ุฅุถุงููุฉ ูุงุญููุง (ุฒู ุนุฏุฏ ุงูุทูุจุงุช)
        return response()->json([
            'id' => $customer->id,
            'name' => $customer->name,
            'phone' => $customer->phone,
            'created_at' => $customer->created_at,
            // 'orders_count' => $customer->orders()->count(),  โ ูู ุนูุฏู ุฌุฏูู ุทูุจุงุช
        ]);
    }
    public function customerOrders($customerId)
    {
        $seller = Auth::user();

        // ุชุฃูุฏ ุฃู ุงูุนููู ูุนูุงู ุชุงุจุน ููุจุงุฆุน
        $isLinked = $seller->customers()->where('users.id', $customerId)->exists();

        if (!$isLinked) {
            return response()->json(['message' => 'ุงูุนููู ุบูุฑ ุชุงุจุน ูู'], 403);
        }

        // ุฌูุจ ุงูุทูุจุงุช ุงููู ุฃูุดุฃูุง ูุฐุง ุงูุจุงุฆุน ููุฐุง ุงูุนููู
        $orders = Order::with('orderdetels.product')
            ->where('seller_id', $seller->id)
            ->where('user_id', $customerId)
            ->orderBy('created_at', 'desc')
            ->get();

        return response()->json($orders);
    }
    // Route: GET /seller/customers/{customer}/orders
    public function sellerCustomerOrders($customer_id)
    {
        $seller = auth()->user();

        if ($seller->role !== 'seller') {
            return response()->json(['error' => 'ุบูุฑ ูุตุฑุญ ูู'], 403);
        }

        $orders = Order::with(['orderdetels.product'])
            ->where('seller_id', $seller->id)
            ->where('user_id', $customer_id)
            ->whereHas('userorder', function ($q) {
                $q->where('role', 'customer');
            })
            ->get();

        return response()->json($orders);
    }
    //ุนุฑุถ ุงูุงุฑุจุงุญ ููู ููุฏูุจ
    // โ ุนุฑุถ ุฃุฑุจุงุญ ุงูููุฏูุจ ุงูุญุงููุฉ ุจุนุฏ ุนูููุงุช ุงูุณุญุจ
    public function myProfits()
    {
        $seller = Auth::user();

        // ุชุฃูุฏ ุฃู ุงููุณุชุฎุฏู ูุนูุงู ููุฏูุจ
        if ($seller->role !== 'seller') {
            return response()->json(['message' => 'ุบูุฑ ูุตุฑุญ ูู'], 403);
        }

        // ุฅุฌูุงูู ุงูุทูุจุงุช ุงูููุงูู ุนูููุง
        $orders = Order::where('seller_id', $seller->id)
            ->where('approval_status', 'approved')
            ->select('id', 'user_id', 'seller_profit', 'total_price', 'created_at')
            ->with('userorder:id,name')
            ->orderBy('created_at', 'desc')
            ->get();

        // ุญุณุงุจ ุฅุฌูุงูู ุงูุฃุฑุจุงุญ ูู ุงูุทูุจุงุช
        $totalProfit = $orders->sum('seller_profit');

        // ุญุณุงุจ ุงููุจุงูุบ ุงููุณุญูุจุฉ (ุงูููุงูู ุนูููุง ููุท)
        $withdrawn = WithdrawRequest::where('seller_id', $seller->id)
            ->where('status', 'approved')
            ->sum('amount');

        // ุงูุฑุตูุฏ ุงููุชุงุญ ุจุนุฏ ุนูููุงุช ุงูุณุญุจ
        $availableProfit = $totalProfit - $withdrawn;

        // ุชุญุฏูุซ ุงูุฑุตูุฏ ูู ุฌุฏูู ุงููุณุชุฎุฏู
        $seller->available_profit = $availableProfit;
        $seller->save();

        return response()->json([
            'seller_id' => $seller->id,
            'seller_name' => $seller->name,
            'total_orders' => $orders->count(),
            'total_profit' => round($totalProfit, 2),
            'withdrawn' => round($withdrawn, 2),
            'available_profit' => round($availableProfit, 2),
            'orders' => $orders->map(function ($order) {
                return [
                    'order_id' => $order->id,
                    'customer_name' => $order->userorder->name ?? '-',
                    'total_price' => $order->total_price,
                    'seller_profit' => $order->seller_profit,
                    'date' => $order->created_at->format('Y-m-d H:i'),
                ];
            }),
        ]);
    }

    // โ ุทูุจ ุณุญุจ ุฌุฒุก ูู ุงูุฃุฑุจุงุญ
    public function requestWithdrawpart(Request $request)
    {
        $seller = auth()->user();

        if ($seller->role !== 'seller') {
            return response()->json(['message' => 'ุบูุฑ ูุตุฑุญ ูู'], 403);
        }

        $request->validate([
            'amount' => 'required|numeric|min:1',
            'note' => 'nullable|string|max:255',
        ]);

        // โ ุชุญูู ุฅู ูููุด ุทูุจ ุณุญุจ ูุนูู ุจุงููุนู
        $pendingRequest = WithdrawRequest::where('seller_id', $seller->id)
            ->where('status', 'pending')
            ->first();

        if ($pendingRequest) {
            return response()->json([
                'message' => 'ูุฏูู ุทูุจ ุณุญุจ ููุฏ ุงููุฑุงุฌุนุฉ ุจุงููุนูุ ูุฑุฌู ุงูุชุธุงุฑ ุงูููุงููุฉ ุนููู ูุจู ุฅูุดุงุก ุทูุจ ุฌุฏูุฏ',
                'pending_request_id' => $pendingRequest->id,
            ], 400);
        }

        // ุฅุฌูุงูู ุงูุฃุฑุจุงุญ ูู ุงูุทูุจุงุช ุงูููุงูู ุนูููุง
        $totalProfit = Order::where('seller_id', $seller->id)
            ->where('approval_status', 'approved')
            ->sum('seller_profit');

        // ุฅุฌูุงูู ุงููุจุงูุบ ุงูุชู ุชู ุณุญุจูุง ูุนูุงู (ุชูุช ุงูููุงููุฉ ุนูููุง)
        $withdrawn = WithdrawRequest::where('seller_id', $seller->id)
            ->where('status', 'approved')
            ->sum('amount');

        // ุงูุฃุฑุจุงุญ ุงููุชุงุญุฉ ุญุงููุงู
        $available = $totalProfit - $withdrawn;

        if ($available <= 0) {
            return response()->json(['message' => 'ูุง ุชูุฌุฏ ุฃุฑุจุงุญ ูุชุงุญุฉ ููุณุญุจ ุญุงููุงู'], 400);
        }

        if ($request->amount > $available) {
            return response()->json([
                'message' => 'ุงููุจูุบ ุงููุทููุจ ูุชุฌุงูุฒ ุงูุฃุฑุจุงุญ ุงููุชุงุญุฉ',
                'available' => round($available, 2)
            ], 400);
        }

        // โ ุฅูุดุงุก ุทูุจ ุณุญุจ ุฌุฏูุฏ
        $withdraw = WithdrawRequest::create([
            'seller_id' => $seller->id,
            'amount' => $request->amount,
            'note' => $request->note,
            'status' => 'pending',
        ]);

        // โ ุฅุฑุณุงู ุฅุดุนุงุฑ ููุฃุฏูู ูุงูููุฏูุจ
        $admins = User::whereIn('role', ['admin', 'delegate'])->get();
        Notification::send($admins, new NewWithdrawRequest($seller, $request->amount));

        // โ ุฅุดุนุงุฑ ููุจุงุฆุน ููุณู
        $seller->notify(new WithdrawRequestSubmitted($request->amount));

        return response()->json([
            'message' => 'ุชู ุฅุฑุณุงู ุทูุจ ุงูุณุญุจ ุจูุฌุงุญ ูุจุงูุชุธุงุฑ ุงููุฑุงุฌุนุฉ',
            'withdraw_request' => $withdraw,
            'available_after_request' => round($available - $request->amount, 2)
        ], 200);
    }


    // ุทูุจ ุณุญุจ ุงุฑุจุงุญ ุงูููุฏูุจ 
    public function requestWithdraw(Request $request)
    {
        $seller = auth()->user();

        if ($seller->role !== 'seller') {
            return response()->json(['message' => 'ุบูุฑ ูุตุฑุญ ูู'], 403);
        }

        $request->validate([
            'amount' => 'required|numeric|min:1',
            'note' => 'nullable|string|max:255',
        ]);

        // ุงุญุณุจ ุฅุฌูุงูู ุงูุฃุฑุจุงุญ ุงูุญุงููุฉ
        $totalProfit = Order::where('seller_id', $seller->id)
            ->where('approval_status', 'approved')
            ->sum('seller_profit');

        // ุงุญุณุจ ุงููุจุงูุบ ุงููู ุชู ุณุญุจูุง ุณุงุจููุง
        $withdrawn = WithdrawRequest::where('seller_id', $seller->id)
            ->where('status', 'approved')
            ->sum('amount');

        $available = $totalProfit - $withdrawn;

        if ($request->amount > $available) {
            return response()->json([
                'message' => 'ุงููุจูุบ ุงููุทููุจ ูุชุฌุงูุฒ ุงูุฃุฑุจุงุญ ุงููุชุงุญุฉ',
                'available' => $available
            ], 400);
        }

        $withdraw = WithdrawRequest::create([
            'seller_id' => $seller->id,
            'amount' => $request->amount,
            'note' => $request->note,
        ]);

        return response()->json([
            'message' => 'ุชู ุฅุฑุณุงู ุทูุจ ุงูุณุญุจ ุจูุฌุงุญุ ุจุงูุชุธุงุฑ ุงููุฑุงุฌุนุฉ',
            'withdraw_request' => $withdraw,
        ], 201);
    }
    //ุนุฑุถ ุทูุจ ุณุญุจ ููููุฏูุจ 
    public function myWithdraws()
    {
        $seller = auth()->user();

        if ($seller->role !== 'seller') {
            return response()->json(['message' => 'ุบูุฑ ูุตุฑุญ ูู'], 403);
        }

        $withdraws = WithdrawRequest::where('seller_id', $seller->id)
            ->orderBy('created_at', 'desc')
            ->get();

        return response()->json($withdraws);
    }

    //ุนุฑุถ ุงุฑุจุงุญ ูู ููุฏูุจ 
    public function sellersProfits()
    {
        // ุชุฃูุฏ ุฃู ุงููุณุชุฎุฏู ุฃุฏูู ููุท
        $user = Auth::user();
        if ($user->role !== 'admin') {
            return response()->json(['message' => 'ุบูุฑ ูุตุฑุญ ูู'], 403);
        }

        // ุงุฌูุน ุฃุฑุจุงุญ ูู ุจุงุฆุน ุจูุงุกู ุนูู ุงูุทูุจุงุช ุงูููุงูู ุนูููุง
        $profits = Order::selectRaw('seller_id, COUNT(*) as total_orders, SUM(seller_profit) as total_profit')
            ->whereNotNull('seller_id')
            ->where('approval_status', 'approved')
            ->groupBy('seller_id')
            ->with('seller:id,name')
            ->get()
            ->map(function ($item) {
                return [
                    'seller_id' => $item->seller_id,
                    'seller_name' => $item->seller?->name ?? 'ุบูุฑ ูุนุฑูู',
                    'total_orders' => $item->total_orders,
                    'total_profit' => round($item->total_profit, 2),
                ];
            });

        return response()->json($profits);
    }
    // ุงูููุงููู ุงู ุฑูุถ ูุทูุจ ุณุญุจ ุงูุงุฑุจุงุญ ุงุฏูู 
    // โ ุงูููุงููู ุงู ุฑูุถ ูุทูุจ ุณุญุจ ุงูุงุฑุจุงุญ ุงุฏูู 
    public function approveWithdraw($id, Request $request)
    {
        $admin = auth()->user();

        if ($admin->role !== 'admin') {
            return response()->json(['message' => 'ุบูุฑ ูุตุฑุญ ูู'], 403);
        }

        $request->validate([
            'status' => 'required|in:approved,rejected',
            'note' => 'nullable|string|max:255',
        ]);

        $withdraw = WithdrawRequest::with('seller')->findOrFail($id);

        if ($withdraw->status !== 'pending') {
            return response()->json(['message' => 'ุชูุช ูุนุงูุฌุฉ ูุฐุง ุงูุทูุจ ูุณุจููุง'], 400);
        }

        // โ ูู ุชูุช ุงูููุงููุฉ ูุชู ุฎุตู ุงููุจูุบ ูู ุฃุฑุจุงุญ ุงูููุฏูุจ
        if ($request->status === 'approved') {
            $seller = $withdraw->seller;

            // ุงุญุณุจ ุงูุฃุฑุจุงุญ ุงููููุฉ ููููุฏูุจ ูู ุงูุทูุจุงุช ุงูููุงูู ุนูููุง
            $totalProfit = Order::where('seller_id', $seller->id)
                ->where('approval_status', 'approved')
                ->sum('seller_profit');

            // ุงุญุณุจ ุงููุจุงูุบ ุงููุณุญูุจุฉ ุณุงุจููุง
            $withdrawn = WithdrawRequest::where('seller_id', $seller->id)
                ->where('status', 'approved')
                ->sum('amount');

            // ุงุญุณุจ ุงูุฑุตูุฏ ุงูุญุงูู ุจุนุฏ ุงูุนูููุฉ ุงูุฌุฏูุฏุฉ
            $available = $totalProfit - $withdrawn;

            // ุญุฏุซ ุงูุฑุตูุฏ ูู ุฌุฏูู ุงููุณุชุฎุฏููู
            $seller->available_profit = $available;
            $seller->save();
        }

        // ุชุญุฏูุซ ุญุงูุฉ ุทูุจ ุงูุณุญุจ
        $withdraw->update([
            'status' => $request->status,
            'note' => $request->note,
        ]);
        // โ ูู ุงูุญุงูุฉ approved ูุฑุณู ุฅุดุนุงุฑ ููููุฏูุจ
        if ($withdraw->status === 'approved') {
            $withdraw->seller->notify(new WithdrawRequestApproved($withdraw->amount));
        }

        // โ ูู ุงูุญุงูุฉ rejected ูุฑุณู ุฅุดุนุงุฑ ุฑูุถ
        if ($withdraw->status === 'rejected') {
            $withdraw->seller->notify(new WithdrawRequestRejected($withdraw->amount, $withdraw->note));
        }
        return response()->json([
            'message' => 'ุชู ุชุญุฏูุซ ุญุงูุฉ ุทูุจ ุงูุณุญุจ ุจูุฌุงุญ',
            'withdraw' => $withdraw,
            'new_balance' => $withdraw->seller->available_profit ?? null,
        ]);
    }


    // โ ุนุฑุถ ูู ุทูุจุงุช ุงูุณุญุจ (ููุฃุฏูู)
    public function allWithdrawRequests()
    {
        $admin = auth()->user();

        // ุชุฃูุฏ ุฃู ุงููุณุชุฎุฏู ุฃุฏูู
        if ($admin->role !== 'admin') {
            return response()->json(['message' => 'ุบูุฑ ูุตุฑุญ ูู'], 403);
        }

        // ุฌูุจ ุฌููุน ุทูุจุงุช ุงูุณุญุจ ูุน ุจูุงูุงุช ุงูููุฏูุจ
        $withdraws = WithdrawRequest::with('seller:id,name,phone')
            ->orderBy('created_at', 'desc')
            ->get()
            ->map(function ($item) {
                return [
                    'id' => $item->id,
                    'seller_id' => $item->seller_id,
                    'seller_name' => $item->seller->name ?? '-',
                    'seller_phone' => $item->seller->phone ?? '-',
                    'amount' => $item->amount,
                    'status' => $item->status,
                    'note' => $item->note,
                    'created_at' => $item->created_at->format('Y-m-d H:i'),
                ];
            });

        return response()->json([
            'message' => 'ุชู ุฌูุจ ุทูุจุงุช ุงูุณุญุจ ุจูุฌุงุญ',
            'withdraw_requests' => $withdraws,
        ]);
    }
    // โ ุชุญุฏูุซ ุญุงูุฉ ุทูุจ ุงูุณุญุจ (ููุฃุฏูู)
    public function updateWithdrawStatus($id, Request $request)
    {
        $admin = auth()->user();

        // ุชุฃูุฏ ุฃู ุงููุณุชุฎุฏู ุฃุฏูู
        if ($admin->role !== 'admin') {
            return response()->json(['message' => 'ุบูุฑ ูุตุฑุญ ูู'], 403);
        }

        // ุงูุชุญูู ูู ุงูุจูุงูุงุช ุงููุฏุฎูุฉ
        $request->validate([
            'status' => 'required|in:pending,approved,rejected',
            'note' => 'nullable|string|max:255',
        ]);

        // ุฌูุจ ุงูุทูุจ
        $withdraw = WithdrawRequest::with('seller:id,name')->findOrFail($id);

        // ููุน ุงูุชุญุฏูุซ ูู ุงูุทูุจ ุจุงููุนู ุชูุช ูุนุงูุฌุชู
        if ($withdraw->status !== 'pending') {
            return response()->json([
                'message' => 'ูุง ูููู ุชุนุฏูู ุญุงูุฉ ุทูุจ ุชูุช ูุนุงูุฌุชู ูุณุจูุงู',
            ], 400);
        }

        // ุชุญุฏูุซ ุงูุญุงูุฉ
        $withdraw->status = $request->status;
        $withdraw->note = $request->note;

        // ูู ุชู ุงูููุงููุฉุ ุงุญูุธ ุชุงุฑูุฎ ุงูููุงููุฉ
        if ($request->status === 'approved') {
            $withdraw->approved_at = now();
        }
        // โ ูู ุงูุญุงูุฉ approved ูุฑุณู ุฅุดุนุงุฑ ููููุฏูุจ
        if ($withdraw->status === 'approved') {
            $withdraw->seller->notify(new WithdrawRequestApproved($withdraw->amount));
        }
        // โ ูู ุงูุญุงูุฉ rejected ูุฑุณู ุฅุดุนุงุฑ ุฑูุถ
        if ($withdraw->status === 'rejected') {
            $withdraw->seller->notify(new WithdrawRequestRejected($withdraw->amount, $withdraw->note));
        }

        $withdraw->save();

        return response()->json([
            'message' => 'ุชู ุชุญุฏูุซ ุญุงูุฉ ุทูุจ ุงูุณุญุจ ุจูุฌุงุญ',
            'withdraw' => [
                'id' => $withdraw->id,
                'seller_name' => $withdraw->seller->name ?? '-',
                'amount' => $withdraw->amount,
                'status' => $withdraw->status,
                'note' => $withdraw->note,
                'approved_at' => $withdraw->approved_at,
            ],
        ]);
    }
}
